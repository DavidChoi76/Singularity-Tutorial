BootStrap: docker
From: continuumio/miniconda3:4.3.11

################################################################################
%setup
################################################################################
cp $PWD/rnaseq_env.yml $SINGULARITY_ROOTFS/opt/rnaseq_env.yml

################################################################################
%post
################################################################################

cat > /etc/locale.gen <<EOF
en_US.UTF-8 UTF-8
EOF
apt-get update
apt-get -y install locales

export PATH=/opt/conda/bin:$PATH
cd /opt
[ -f rnaseq_env.yml ] || exit 1

# create the rnaseq environment
conda env create -n rnaseq -f rnaseq_env.yml

# clean up so image can be shrunk
conda clean --index-cache --tarballs --yes

# create the biowulf specific directories for binding file systems
mkdir /gpfs /spin1 /gs2 /gs3 /gs4 /gs5 /gs6 /data /scratch /fdb /lscratch

# set up the environment for the container
################################################################################
%environment
################################################################################
export SINGULARITY_INIT=1
export PATH=/opt/conda/envs/rnaseq/bin:/opt/conda/bin:/bin:/usr/bin
export PS1="Singularity.$SINGULARITY_CONTAINER> $PS1"
export LANG=en_US.UTF-8
export CONTAINER_VER=0.1
export CONDA_DEFAULT_ENV=rnaseq
export CONDA_PREFIX=/opt/conda/envs/rnaseq
export ANACONDA_HOME=/opt/conda

################################################################################
%runscript
################################################################################

# In this case using the runscript only for self documentation.

cat <<EOF

------------------------------------------------------------
rnaseq - rnaseq pipeline tools version $CONTAINER_VER
------------------------------------------------------------

This container encapsulates tools for RNA-Seq analysis.
It is intended for creating reproducible pipelines.

Installed software:

EOF

conda list


################################################################################
%test
################################################################################
. /.singularity.d/env/90-environment.sh
conda list

